---
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');
const categories = [...new Set(allPosts.map(post => post.data.category || '未分类'))];
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))];

interface Props {
  showArticleList?: boolean;
  articles?: Array<{
    slug: string;
    title: string;
  }>;
}

const { showArticleList = false, articles = [] } = Astro.props;
---

<aside class="left-sidebar">
  <div class="author-card glass-card scroll-reveal">
    <div class="author-avatar">
      <img src="/images/avatar.jpg" alt="XingGreen" />
    </div>
    <h3 class="author-name">XingGreen</h3>
    <p class="author-quote">代码如诗，算法如画</p>
    <div class="author-links">
      <a href="https://space.bilibili.com" target="_blank" rel="noopener noreferrer" aria-label="Bilibili">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M18.7 5.7h-1.3V4.3c0-.4-.3-.7-.7-.7s-.7.3-.7.7v1.4H8V4.3c0-.4-.3-.7-.7-.7s-.7.3-.7.7v1.4H5.3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h13.4c1.1 0 2-.9 2-2v-10c0-1.1-.9-2-2-2zm.7 12c0 .4-.3.7-.7.7H5.3c-.4 0-.7-.3-.7-.7V9h14v8.7z"/>
        </svg>
      </a>
      <a href="https://github.com" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
      </a>
    </div>
  </div>

  {showArticleList && articles.length > 0 ? (
    <div class="article-list-card glass-card scroll-reveal">
      <h4 class="card-title">文章目录</h4>
      <ul class="article-list">
        {articles.map(article => (
          <li>
            <a href={`/blog/${article.slug}`}>{article.title}</a>
          </li>
        ))}
      </ul>
    </div>
  ) : (
    <>
      <div class="announcement-card glass-card scroll-reveal">
        <h4 class="card-title">公告</h4>
        <p class="announcement-content">欢迎来到我的博客！这里分享技术与生活的点滴。</p>
      </div>

      <div class="categories-card glass-card scroll-reveal">
        <h4 class="card-title">分类</h4>
        {categories.length > 0 ? (
          <ul class="categories-list">
            {categories.map(category => {
              const count = allPosts.filter(post => post.data.category === category).length;
              return (
                <li><a href={`/category/${category}`}>{category} ({count})</a></li>
              );
            })}
          </ul>
        ) : (
          <p class="announcement-content">暂无分类</p>
        )}
      </div>

      <div class="tags-card glass-card scroll-reveal">
        <h4 class="card-title">标签</h4>
        {allTags.length > 0 ? (
          <div class="tags-cloud">
            {allTags.map(tag => (
              <a href={`/tag/${tag}`} class="tag">{tag}</a>
            ))}
          </div>
        ) : (
          <p class="announcement-content">暂无标签</p>
        )}
      </div>
    </>
  )}

  <div class="github-wall glass-card scroll-reveal">
    <h4 class="card-title">文章统计</h4>
    <div class="contributions-grid">
      {Array.from({ length: Math.min(allPosts.length, 20) }).map((_, i) => (
        <div class="contribution-cell" style={`--level: ${Math.floor(Math.random() * 5)}`}></div>
      ))}
    </div>
    <p class="stats-info">共 {allPosts.length} 篇文章</p>
  </div>
</aside>

<style>
  .left-sidebar {
    position: sticky;
    top: 80px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
  }

  .author-card {
    padding: 24px;
    text-align: center;
  }

  .author-avatar {
    width: 120px;
    height: 120px;
    margin: 0 auto 16px;
    border-radius: 8px;
    overflow: hidden;
  }

  .author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .author-name {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-primary);
  }

  .author-quote {
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-style: italic;
    margin-bottom: 16px;
  }

  .author-links {
    display: flex;
    justify-content: center;
    gap: 16px;
  }

  .author-links a {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--mint-green);
    border-radius: 8px;
    color: var(--text-primary);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .author-links a:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(152, 255, 152, 0.3);
    background: rgba(152, 255, 152, 0.1);
  }

  .card-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-primary);
    padding-bottom: 8px;
    border-bottom: 2px solid var(--mint-green);
  }

  .announcement-card,
  .categories-card,
  .tags-card,
  .article-list-card,
  .github-wall {
    padding: 20px;
  }

  .announcement-content {
    font-size: 0.9rem;
    color: var(--text-secondary);
    line-height: 1.6;
  }

  .categories-list,
  .article-list {
    list-style: none;
  }

  .categories-list li,
  .article-list li {
    margin-bottom: 8px;
  }

  .categories-list a,
  .article-list a {
    color: var(--text-primary);
    font-size: 0.9rem;
    display: block;
    padding: 6px 12px;
    border-radius: 6px;
    transition: all 0.3s ease;
  }

  .categories-list a:hover,
  .article-list a:hover {
    background: rgba(152, 255, 152, 0.1);
    color: var(--mint-green);
    padding-left: 16px;
  }

  .tags-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .tag {
    padding: 6px 12px;
    font-size: 0.85rem;
    color: var(--text-primary);
    background: rgba(152, 255, 152, 0.1);
    border: 1px solid var(--mint-green);
    border-radius: 20px;
    transition: all 0.3s ease;
  }

  .tag:hover {
    background: var(--mint-green);
    color: var(--forest-dark);
  }

  .contributions-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }

  .contribution-cell {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    background: rgba(152, 255, 152, calc(0.1 + var(--level) * 0.2));
  }

  .stats-info {
    margin-top: 12px;
    font-size: 0.85rem;
    color: var(--text-secondary);
    text-align: center;
  }

  @media (max-width: 1024px) {
    .left-sidebar {
      position: static;
      max-height: none;
    }
  }

  @media (max-width: 768px) {
    .left-sidebar {
      gap: 16px;
    }

    .author-card {
      padding: 20px;
    }

    .author-avatar {
      width: 100px;
      height: 100px;
    }

    .author-name {
      font-size: 1.3rem;
    }
  }
</style>
