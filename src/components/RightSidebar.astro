---
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');
const categories = [...new Set(allPosts.map(post => post.data.category || '未分类'))];
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))];

const siteStats = {
  posts: allPosts.length,
  categories: categories.length,
  tags: allTags.length,
  createdAt: new Date('2024-01-01T00:00:00')
};

const articles = allPosts.map(post => ({
  title: post.data.title,
  slug: post.slug,
  excerpt: post.data.description || ''
}));
---

<aside class="right-sidebar">
  <div class="search-card glass-card scroll-reveal">
    <h4 class="card-title">搜索</h4>
    <div class="search-box">
      <input 
        type="text" 
        id="search-input" 
        placeholder="搜索文章..." 
        aria-label="搜索文章"
      />
      <button id="search-btn" aria-label="搜索">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
    </div>
    <div id="search-results" class="search-results"></div>
  </div>

  <div class="calendar-card glass-card scroll-reveal">
    <h4 class="card-title">日历</h4>
    <div class="calendar" id="calendar"></div>
  </div>

  <div class="site-info-card glass-card scroll-reveal">
    <h4 class="card-title">站点信息</h4>
    <ul class="site-stats">
      <li>
        <span class="stat-label">文章总数</span>
        <span class="stat-value">{siteStats.posts}</span>
      </li>
      <li>
        <span class="stat-label">分类总数</span>
        <span class="stat-value">{siteStats.categories}</span>
      </li>
      <li>
        <span class="stat-label">标签总数</span>
        <span class="stat-value">{siteStats.tags}</span>
      </li>
      <li>
        <span class="stat-label">运行时间</span>
        <span class="stat-value" id="runtime">加载中...</span>
      </li>
    </ul>
  </div>
</aside>

<style>
  .right-sidebar {
    position: sticky;
    top: 80px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
  }

  .search-card,
  .calendar-card,
  .site-info-card {
    padding: 20px;
  }

  .card-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-primary);
    padding-bottom: 8px;
    border-bottom: 2px solid var(--mint-green);
  }

  .search-box {
    display: flex;
    gap: 8px;
  }

  .search-box input {
    flex: 1;
    padding: 10px 14px;
    border: 2px solid var(--mint-green);
    border-radius: 8px;
    background: transparent;
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    transition: all 0.3s ease;
  }

  .search-box input:focus {
    box-shadow: 0 0 0 3px rgba(152, 255, 152, 0.2);
  }

  .search-box input::placeholder {
    color: var(--text-secondary);
  }

  .search-box button {
    width: 42px;
    height: 42px;
    border: 2px solid var(--mint-green);
    border-radius: 8px;
    background: transparent;
    color: var(--text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .search-box button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(152, 255, 152, 0.3);
    background: rgba(152, 255, 152, 0.1);
  }

  .search-results {
    margin-top: 12px;
    max-height: 200px;
    overflow-y: auto;
  }

  .search-result-item {
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .search-result-item:hover {
    background: rgba(152, 255, 152, 0.1);
  }

  .search-result-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .search-result-excerpt {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    text-align: center;
  }

  .calendar-day {
    padding: 8px 4px;
    font-size: 0.85rem;
    border-radius: 4px;
    color: var(--text-primary);
    transition: all 0.3s ease;
  }

  .calendar-day:hover {
    background: rgba(152, 255, 152, 0.1);
  }

  .calendar-day.today {
    background: var(--mint-green);
    color: var(--forest-dark);
    font-weight: 600;
  }

  .calendar-day.other-month {
    color: var(--text-secondary);
    opacity: 0.5;
  }

  .calendar-header {
    font-weight: 600;
    color: var(--forest-light);
    padding: 8px 4px;
  }

  .site-stats {
    list-style: none;
  }

  .site-stats li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--glass-border);
  }

  .site-stats li:last-child {
    border-bottom: none;
  }

  .stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .stat-value {
    color: var(--mint-green);
    font-weight: 600;
    font-size: 0.95rem;
  }

  @media (max-width: 1024px) {
    .right-sidebar {
      position: static;
      max-height: none;
    }
  }

  @media (max-width: 768px) {
    .right-sidebar {
      gap: 16px;
    }

    .search-card,
    .calendar-card,
    .site-info-card {
      padding: 16px;
    }
  }
</style>

<script define:vars={{ articles }}>
  import Fuse from 'fuse.js';

  const fuse = new Fuse(articles, {
    keys: ['title', 'excerpt'],
    threshold: 0.3
  });

  const searchInput = document.getElementById('search-input');
  const searchBtn = document.getElementById('search-btn');
  const searchResults = document.getElementById('search-results');

  function performSearch() {
    const query = searchInput.value.trim();
    if (!query) {
      searchResults.innerHTML = '';
      return;
    }

    const results = fuse.search(query);
    if (results.length === 0) {
      searchResults.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9rem;">未找到相关文章</p>';
      return;
    }

    searchResults.innerHTML = results.map(result => `
      <div class="search-result-item" onclick="window.location.href='/blog/${result.item.slug}'">
        <div class="search-result-title">${result.item.title}</div>
        <div class="search-result-excerpt">${result.item.excerpt}</div>
      </div>
    `).join('');
  }

  searchInput.addEventListener('input', performSearch);
  searchBtn.addEventListener('click', performSearch);

  const calendar = document.getElementById('calendar');
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const today = now.getDate();

  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay();

  const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
  let calendarHTML = weekDays.map(day => `<div class="calendar-header">${day}</div>`).join('');

  for (let i = 0; i < firstDay; i++) {
    calendarHTML += '<div class="calendar-day other-month"></div>';
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const isToday = day === today ? 'today' : '';
    calendarHTML += `<div class="calendar-day ${isToday}">${day}</div>`;
  }

  calendar.innerHTML = calendarHTML;

  const runtimeEl = document.getElementById('runtime');
  const createdAt = new Date('2024-01-01T00:00:00');

  function updateRuntime() {
    const now = new Date();
    const diff = now - createdAt;

    const years = Math.floor(diff / (1000 * 60 * 60 * 24 * 365));
    const months = Math.floor((diff % (1000 * 60 * 60 * 24 * 365)) / (1000 * 60 * 60 * 24 * 30));
    const days = Math.floor((diff % (1000 * 60 * 60 * 24 * 30)) / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

    runtimeEl.textContent = `${years}年${months}月${days}天 ${hours}时${minutes}分${seconds}秒`;
  }

  updateRuntime();
  setInterval(updateRuntime, 1000);
</script>
